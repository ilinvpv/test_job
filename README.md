# Отчет по выполнению тестового задания

Используемая версия интерпретатора: 3.5

## Содержание проекта:
* `web_app/` - тестируемое приложение
* `tests/report/` - отчет
* `tests/test_api.robot` - тест
* `tests/lib/` - модули реализованные на Python
* `tests/resources/` - подключение библиотек
* `tests/config.py` - файл конфигурации
* `requirements.txt` - зависимости теста

---

## Установка окружения тестируемого приложения
Для запуска необходимо приложение [Docker](https://docs.docker.com/engine/installation/) с утилитой Docker-Compose.

Для версий Windows выпущенных до Windows 10 необходимо использовать [Docker Toolbox](https://www.docker.com/products/docker-toolbox) и выполнить дополнительную настройку:
  - запустить VirtualBox(устанавливается вместе с Docker);
  - выбрать виртуальную машину default;
  - выбрать "Настроить";
  - выбрать "Сеть";
  - в "дополнительно" выбрать "Проброс портов";
  - добавить правило:
  
|   Имя  | Протокол | Адрес хоста | Порт хоста | Адрес гостя | Порт гостя |
|:------:|:--------:|:-----------:|:----------:|:-----------:|:----------:|
| Rule # |    TCP   |  127.0.0.1  |    5000    |             | 5000       |

Если порт 5000 занят, можно указать другой в "порт хоста".


## Запуск окружения тестируемого приложения
Выполнить:
  - `cd {директория с приложением}`
  - `docker-compose build`
  - `docker-compose up`
  
_В ОС Windows команды запускать в Docker Quickstart Terminal_

Для проверки работоспособности в браузере ввести в адресной строке `http://localhost:5000`, должно появиться сообщение `It's alive!`

---
## Подготовка окружения для автотеста
Автотест реализован с помощью RobotFramework версии 3.0.4, для выполнения запросов к API используется библиотека requests версии 2.18.4
Данные зависимости указанны в файле `requirements.txt` 

Для их установки необходимо выполнить команду:

```
pip install -r requirements.txt
```

## Конфигурация автотеста:
Конфигурационные константы находятся в файле `tests/config.py`

Константа `DB_PATH` содержит путь файла БД. Пример: `DB_PATH = '../web_app/web/clients.db'`

Константа `API_URL` содержит информацию о корневом роуте API и указывается в формате `{schema}://{host}:{port}` Пример: `API_URL = 'http://localhost:5000'`


## Запуск автотеста
Для запуска теста необходимо перейти в директорию tests и выполнить команду:
```
robot -d report --variablefile config.py test_api.robot
```


## Алгоритм работы автотеста:

1. Подключиться к SQLite базе данных `../web_app/web/clients.db`. Настроки пути БД указываются в файле конфигурации
2. Получить из БД клиента с положительным балансом. Если клиента нет - создать нового и зафиксировать баланс клиента и его идентификатор
3. Получить список подключенных клиенту услуг с помощью `POST запроса` `{API_URL}/client/services`
4. Получить список всех услуг с помощью `GET` запроса `{API_URL}/client/services`
5. Найти услугу, которую можно подключить
6. Поключить услугу с помощью `POST` запроса `{API_URL}/client/add_service`
7. Ожидать появления услуги в течении 1 минуты
8. Выполнить запрос на получение баланса клиента
9. Сравнить: `{конечный баланс} = {начальный баланс} - {стоимость подключения услуги}`

**Ожидаемое поведение: значения равны**

## В ходе реализации автотеста возникли следующие проблемы:


|  **Проблема**|**Решение**  |
|--|--|
| В базу, используемую автотестом, не записываются данные со стороны приложения. Как следствие нет возможности проверить корректность работы API метода. | Мной было принято решение использовать монтирование БД вместо копирования. Дополненный docker-compose.yml приложен. Если же придерживаться оригинальной конфигурации, на этапе проверки подключенных клиенту услуг (пункт 7) кейворд не найдет услугу по таймауту и прервет выполнение теста |
| В случае если у клиента нет доступных для подключения услуг тест завершится в шаге 5 с ошибкой, хотя найденный клиент и удовлетворяет условиям.|Мной было принято решение дополнить изначальное условие и выбирать клиента с положительным балансом и доступными для подключения услугами. Для этого пришлось затронуть недокументированные таблицы `CLIENT_SERVICE` и `SERVICES`|
